# AWSでサーバーを構築してみる（ハンズオン）
実際にEC2インスタンスを構築し、サーバーソフトウェアを導入してみましょう。
## 1. EC2インスタンスの構築
AWS上にEC2インスタンスを構築していきます。
### 1-1. EC2の管理画面へ移動
![](../../aws_cp_ec2_hands_on_make_instance_1.png)
検索窓に「EC2」と入力し、EC2の管理画面に移動します。
### 1-2. インスタンスの起動
![](../../aws_cp_ec2_hands_on_make_instance_2.png)
「インスタンスの起動」をクリックします。
### 1-3. インスタンスの起動 - AMIの選択
![](../../aws_cp_ec2_hands_on_make_instance_3.png)  
OSやソフトウェア構成を選択します。  
今回はEC2を使う上で最も標準的なAmazonLinuxの「Amazon Linux 2 AMI (HVM), SSD Volume Type」の「選択」をクリックしてください。  
なおAmazonLinuxとはAWSが提供しているLinuxOSで、RedHat7もしくはCentOS7とほぼ同等に操作することができます。
### 1-4. インスタンスタイプの選択
![](../../aws_cp_ec2_hands_on_make_instance_4.png)  
インスタンスのスペックを選択します。
今回はアカウント登録から１年間無料利用枠が提供されている「t2.micro」を選択して、「次のステップ：インスタンスの詳細の設定」をクリックしてください。
### 1-5. インスタンスの設定
![](../../aws_cp_ec2_hands_on_make_instance_5.png)
インスタンスを作成する数やインスタンスの購入方法などインスタンスの各種設定を設定します。  
「自動割り当てパブリック IP」が「サブネット設定を使用（有効）」か「有効」になっていることを確認してください。  
上記の設定になっていることで自動的にパブリックIPアドレスがEC2インスタンスに割り当てられます。  
今回はそれ以外はデフォルトの設定のまま「次のステップ：ストレージの追加」をクリックしてください。  
### 1-6. ストレージの追加
![](../../aws_cp_ec2_hands_on_make_instance_6.png)
インスタンスにアタッチするストレージの設定を行います。  
ストレージのサイズを変更したり、ボリュームタイプというディスクの種類をSSDやHDDなどから選択したり、暗号化の設定をすることができます。  
今回はデフォルト設定のまま「次のステップ：タグの追加」をクリックしてください。
### 1-7. タグの追加
![](../../aws_cp_ec2_hands_on_make_instance_7.png)
インスタンスを管理するためのタグの設定を行います。  
作成するインスタンスに合わせて設定を行うことで、例えば各サーバーに分かり易い名前を付けたり、システム毎にインスタンスを分けて管理することができます。
今回はタグは追加せずに「次のステップ：セキュリティグループの設定」をクリックしてください。
### 1-8. セキュリティグループの設定
![](../../aws_cp_ec2_hands_on_make_instance_8.png)
インスタンスのトラフィックを制御するファイアウォールの設定をします。  
今回は後ほどサーバーにログインして作業を行う必要を行うのにSSHを、ブラウザからWebページを表示するためにHTTPを追加します。  
追加できたら「確認と作成」をクリックしてください。
### 1-9. 設定の確認
![](../../aws_cp_ec2_hands_on_make_instance_9.png)
作成を行う前に設定内容を確認します。  
設定内容に問題がなければ「起動」をクリックしてください。
### 1-10. キーペアの選択・作成
![](../../aws_cp_ec2_hands_on_make_instance_10.png)
サーバーへのログインに使用するセキュリティキーを設定します。
既に作成済みで手元にキーペアがある場合は「既存のキーペアを選択」を選択して対象のキーペアを選択します。  
今回は初めてのインスタンス構築になりますので「新しいキーペアの作成」を選択し、キーペア名を入力してください。  
キーペア名が入力できたら「キーペアのダウンロード」をクリックしてキーペアを自分のPCにダウンロードしておき、「インスタンスの作成」をクリックしてインスタンスの作成を開始させます。
### 1-11. インスタンスの作成確認
![](../../aws_cp_ec2_hands_on_make_instance_11.png)
「インスタンスは現在作成中です」と表示されることを確認します。  
確認できたら「次のインスタンスの作成が開始されました：」の右側にあるインスタンスIDをクリックしてください。  
インスタンスIDはEC2インスタンスに割り当てられる一意のIDになります。  

![](../../aws_cp_ec2_hands_on_make_instance_12.png)
インスタンスIDをクリックするとEC2インスタンスの一覧が表示され、先程作成を開始したインスタンスが表示されていると思います。  
インスタンスの状態が「実行中」になっていることを確認してください。
## 2. EC2インスタンスへの接続
構築したEC2インスタンスにSSHソフトウェアのTeraTermで接続してみます。  
（WindowsからはSSHソフトウェアを利用して接続します）
### 2-1. EC2のパブリックアドレスの確認
![](../../aws_cp_ec2_hands_on_connect_instance_1.png)
EC2インスタンスに接続して実際にサーバーを操作するためにはまずEC2の接続先であるパブリックアドレスを確認する必要があります。  
EC2インスタンスの一覧から先ほど作成したインスタンスを選択すると下部に選択したインスタンスの情報が表示されます。  
その中の「詳細」タブを選択し「パブリックIPv4アドレス」に表示されているIPアドレスをコピーしておきます。
### 2-2. TeraTermでのログイン - 接続情報の入力
![](../../aws_cp_ec2_hands_on_connect_instance_2.png)
TeraTermを起動して以下のように入力して「OK」をクリックします。
```
ホスト：先ほどコピーしたIPアドレス
サービス：SSH
TCPポート：22
SSHバージョン：SSH2
IPバージョン：AUTO
```
### 2-3. TeraTermでのログイン - セキュリティ警告
![](../../aws_cp_ec2_hands_on_connect_instance_3.png)
セキュリティ警告が表示されますが、「このホストをknown hostsリストに追加する」にチェックを入れて「続行」をクリックします。  
### 2-4. TeraTermでのログイン - 認証情報の入力
![](../../aws_cp_ec2_hands_on_connect_instance_4.png)
以下のように入力して「OK」をクリックします。
```
ユーザ名：ec2-user
認証方式：RSA/DSA/ECDSA/ED25519鍵を使う
　秘密鍵：先ほどダウンロードしたキーペア
```
### 2-5. TeraTermでログイン確認
![](../../aws_cp_ec2_hands_on_connect_instance_5.png)
EC2インスタンスにログインできたことを確認します。
## 3. サーバーソフトウェアの導入
EC2インスタンスに接続できたらWebサーバーの役割を持たせるために設定していきます。
### 3-1. rootユーザへの切り替え
以下のコマンドを実行してrootユーザに切り替えます。
```shell
sudo su
```
### 3-2. yumの最新化
以下のコマンドを実行してyumを最新化します。  
yumとはLinuxのソフトウェアのパッケージを管理するツールになります。  
下記コマンドを実行することでyumで管理しているパッケージを全て最新にすることができます。  
少し時間がかかりますが「Complete!」と表示されたら完了です。
```shell
yum update -y
```
### 3-3. Apacheのインストール
WebサーバーソフトウェアであるApacheを下記のコマンドでインストールします。
```shell
yum install httpd -y
```
### 3-4. Apacheの起動
以下のコマンドでApacheを起動します。
```shell
systemctl start httpd
```
再度下記のコマンドを実行して「active (running)」と表示されていれば起動しています。
```shell
systemctl status httpd
```
### 3-5. Webページの作成
Apacheをインストールすると自動で/var/www/htmlというWebサイトのHTMLファイルを配置するディレクトリが作成されます。  
以下のコマンドを実行して/var/www/html/ディレクトリ配下にindex.htmlというHTMLファイルを作成します。
```shell
echo "<html><h1>HelloWorld</h1></html>" > /var/www/html/index.html
```
### 3-6. Webページの表示
![](../../aws_cp_ec2_hands_on_install_apache_1.png)
ブラウザを起動してEC2インスタンスのパブリックIPv4アドレスをURL欄に入力してEnterを押します。  
そうすると「HelloWorld」と表示されるページに移動できるはずです。  
これでEC2をWebサーバーとして構築できたことになります。  
もし上手く表示されない場合は以下のコマンドを実行してApacheを再起動してみましょう。
```shell
systemctl restart httpd
```
## 4. AMIの取得
EC2インスタンスのバックアップに相当するAMIを取得していきます。
### 4-1. EC2インスタンスの選択
![](../../aws_cp_ec2_hands_on_get_ami_1.png)
EC2インスタンスの一覧からAMIを取得するインスタンスを選択します。
### 4-2. イメージの作成
![](../../aws_cp_ec2_hands_on_get_ami_2.png)
「アクション」-「イメージとテンプレート」-「イメージを作成」をクリックします。  

![](../../aws_cp_ec2_hands_on_get_ami_3.png)
「イメージ名」と「イメージの説明」に「test」と入力して、「イメージを作成」をクリックします。
### 4-3. イメージの取得確認
![](../../aws_cp_ec2_hands_on_get_ami_4.png)  
左メニューから「イメージ」-「AMI」をクリックします。  

![](../../aws_cp_ec2_hands_on_get_ami_5.png)  
先ほど作成したAMIが表示されていることを確認します。  

これで今回作成したインスタンスのAMIを取得することができました。  
このAMIを基にインスタンスを作成することでApacheがインストールされている状態のEC2インスタンスを構築することができます。