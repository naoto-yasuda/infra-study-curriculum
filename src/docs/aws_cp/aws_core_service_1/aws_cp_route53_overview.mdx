# Route53の概要
## 1. DNSについて
### 1-1. IPアドレスとURLの関係
![](../../aws_cp_route53_overview_ipaddress_and_url.png)
IPアドレスがサーバーやネットワーク機器の住所の役割を担うものになりますが、数字の羅列のため人間には分かりにくいものになっています。  
そのためホームページ等にアクセスする際は人間にも分かり易いURLに変換されて利用をしています。  
### 1-2. DNSサーバーとは
![](../../aws_cp_route53_overview_dnsserver_image.png)
DNS（Domain Name System）サーバーはURLとIPアドレスの対応関係を管理し変換をしてくれるサーバーです。  
またどこにどういったURLやIPアドレスが所属しているかを管理しておりそれを教えてくれる機能も持っています。
### 1-3. リクエストとレスポンス時のDNSサーバーの動き
![](../../aws_cp_route53_overview_request_dnsserver_image.png)
リクエストとレスポンスのやり取りがWebアプリケーションの基本的な動きにはなりますが、リクエストを送信する際にDNSサーバーにURLのIPアドレスを確認して、送信先を特定するという動きをしています。
## 2. Route53について
### 2-1. Route53とは
![](../../aws_cp_route53_overview_Route53_image.png)
上述したDNSサーバーの役割をAWS上で行っているのがRoute53になります。  
DNSレコードというIPアドレスとURLを紐付けた表を確認することでルーティングを行っています。
### 2-2. Route53の特徴
Route53は権威DNSサーバーの機能をAWSが管理するマネジメント型で簡単に利用できるサービスで、ユーザー側では冗長構成を意識する必要がありません。  
それ以外の主な特徴は以下の通りです。
- 主要機能はドメイン登録／DNSルーティング／ヘルスチェックの3つ
- ポリシーによるルーティング設定  
　→トラフィックルーティング／フェイルオーバー／トラフィックフローに基づく様々な条件のルーティング設定が可能
- AWS側で100％可用性を保証するSLA  
  →AWS側で絶対にサービスが停止しないことを保証しています。  
  →→なぜならRoute53に問題が起きてしまうとURLによるサーバーへのアクセスができなくなってしまいクリティカルな影響があるため
- マネージドサービスとして提供しており、ユーザー側で冗長性などを考慮する必要がない
### 2-3. Route53の利用方法
Route53の利用を開始してドメインを登録するとホストゾーンを自動生成し、そのホストゾーンに対してルーティングを設定していきます。  
流れとしては、
1. Route53にドメインを設定
2. ドメイン名と同じホストゾーンを自動生成
3. ホストゾーンにルーティング方法となるDNSレコードを作成
4. トラフィックルーティングを設定  

というような形です。
### 2-4. ホストゾーンについて
ドメイン（例：example.com）とそのサブドメイン(例：sub.example.com） のトラフィックのルーティングする方法についての情報を保持するコンテナをホストゾーンと言います。  
ホストゾーンにはパブリックホストゾーンとプライベートホストゾーンの２種類があり、それぞれに異なる特徴を持っています。  
#### 2-4-1. パブリックホストゾーンの特徴
- インターネット上に公開されたDNSドメインレコードを管理するコンテナ
- インターネットのDNSドメインに対するトラフィックのルーティング方法を定義
- 基本的にインターネットと繋がる部分のルーティングの方法を定義するホストゾーン
#### 2-4-2. プライベートホストゾーンの特徴
- VPCに閉じたプライベートネットワーク内のDNSドメインのレコードを管理するコンテナ
- VPC内のDNSドメインに対して、どのようにトラフィックをルーティングするかを定義
- 1つのプライベートホストゾーンで複数VPCに対応
- VPCが相互アクセス可能であれば複数リージョンのVPCでも、同じホストゾーンを利用可能
### 2-5. トラフィックルーティングのタイプ
ルーティングとはどこのサーバー、リソースにトラフィックをルートさせるのかという制御をDNS側でしてくれる機能です。  
例えば「このIPアドレスならば、このIPアドレスがあるサーバーはこちらです」というような形で案内するようなイメージです。
様々なルーティング方式を選択して設計をすることが可能です。
#### 2-5-1. シンプルルーティング
- レコードセットで事前に設定された値のみに基づいてDNSクエリに応答する
- 静的なマッピングによりルーティングを決定
- IPアドレスと設定したドメイン名を単純にルーティングする
#### 2-5-2. 加重ルーティング
- 複数エンドポイント毎の重み設定によりDNSクエリに応答する
- 重み付けの高いエンドポイントに多くルーティングする
- 例えば東京、シンガポール、シドニーの３箇所にルーティング先を配置したとして、それぞれの重みを同じ３ずつにするとシンプルルーティングと同様な均等に配分されたルーティングの動きになりますが、東京だけを５０％にして他を２５％ずつにすることで東京への割合を高めにしたルーティングにすることができます
#### 2-5-3. フェイルオーバールーティング
- ヘルスチェックの結果に基づいて、利用可能なリソースをDNSクエリに応答する
- 利用可能なリソースにのみルーティングされる
- プライマリ（メイン）、セカンダリ（サブ）とサーバーが用意してある状態で、通常時はプライマリにルーティングを行うものの、プライマリのサーバーで何か問題が起きて利用できなくなった時にセカンダリへとルーティングすることができます
#### 2-5-4. 複数値回答ルーティング
- ランダムに選ばれた最大８つの別々のレコードを使用してIPアドレスを設定して、複数の値を返答する
- IPアドレス単位でヘルスチェックを実施してルーティングすることで、正常なリソースの値を返す
  ELBに代わるものではないが、正常であることが確認できる複数のIPアドレスを返す機能により、DNSを使用してアベイラビリティーとロードバランシングを向上させることが可能
#### 位置情報を利用したルーティング
ここからの３つはいずれも位置情報を利用したルーティングで、全体的に近しい使い方になります。
#### 2-5-5. レイテンシールーティング
- リージョンの遅延によりDNSクエリに応答する
- 基本的にはユーザの最寄りのリージョンに返答する
- リージョン間の遅延が少ない方へルーティングされる
- 例えば東京、シンガポール、シドニーの３箇所にルーティング先が配置されていた場合、東京のユーザの場合は基本的に東京リージョンが最も遅延が少ないため東京リージョンにルーティングされます  
  逆にシンガポールのユーザの場合は東京よりシンガポールのほうが基本的には遅延が少ないのでシンガポールにルーティングされます
#### 2-5-6. 位置情報ルーティング
- ユーザのIPアドレスにより位置情報を特定して、地域ごとに異なるレコードを返す
- ネットワーク構成に依拠しない、制度の高いレコードの区分けが可能
- 例えば日本からのユーザであれば日本語表示で、韓国からのユーザの場合は韓国語表示のページへルーティングするというような用途に利用できます
#### 2-5-7. 地理的近接性ルーティング
- ユーザとリソースの場所に基づいて地理的近接性ルールを作成して、トラフィックをルーティングする
   - AWSリソースを使用している場合は、リソースを作成したAWSリージョン
   - AWS以外のリソースを使用している場合は、リソースの緯度と経度
- 必要に応じてバイアスを設定し、特定のリソースにルーティングするトラフィックの量を変更できる
- トラフィックフローを利用する必要がある
- かなりユースケースの限られる特殊なルーティング
### 2-6. トラフィックフロー
![](../../aws_cp_route53_overview_trafficflow_image.png)
フローチャートの形式でトラフィックフローのルーティングポリシーを設定することができます。