# VPCの概要
## 1. VPCとは
![](../../aws_cp_vpc_overview_vpc_image.png)
VPC（Virtual Private Cloud）はAWSのネットワークからユーザ専用の領域を切り出すことができる仮想ネットワークのサービスです。  
VPCはAWSクラウド内に論理的に分離されたセクションを作り、ユーザが定義した仮想ネットワークを構築できます。  

特徴をまとめると以下のようになります。  
- 任意のIPアドレス範囲を選択して仮想ネットワークを構築する  
- サブネットの作成、ルートテーブルやネットワークゲートウェイの設定などにより、仮想ネットワーキング環境を完全に制御できる  
- 必要に応じてクラウド内外のネットワーク同士を接続することも可能  
- 複数の接続オプションが利用可能  
    - インターネット経由  
    - VPN/専用線(Direct Connect)
## 2. VPCとAZ
![](../../aws_cp_vpc_overview_vpc_single_az.png)
VPCを構築するとデフォルトでは単一のAZが範囲として設定されます。

![](../../aws_cp_vpc_overview_vpc_multi_az.png)
VPC内でサブネットを複数AZにまたがった状態で作成することで複数のAZをVPCの範囲とすることができます。
## 3. VPCとサブネット
![](../../aws_cp_vpc_overview_vpc_and_subnet.png)
VPCはサブネットを組み合わせることでネットワーク空間を構築します。  
VPCはサブネットとセットで利用するのが必須になります。  
## 4. VPCの設定
### 4-1. デフォルトVPC
AWSアカウントを作成すると自動的に各リージョンに１つずつデフォルトVPCとデフォルトサブネットが生成されます。  

デフォルトVPCとデフォルトサブネットは以下のような設定になっています。  
- サイズ/16のIPv4CIDRブロック（172.31.0.0/16）のVPCを作成する  
　これは最大65,536個のプライベートIPv4アドレスを提供する  
- 各アベイラビリティーゾーンに、サイズ/20 のデフォルトサブネットを作成する  
　この場合はサブネットあたり最大4,096個のアドレスが作成され、その中のいくつかはAmazonが使用するように予約されている  
- インターネットゲートウェイを作成して、デフォルトVPCに接続する  
- デフォルトのセキュリティグループを作成し、デフォルトVPCに関連付ける  
- デフォルトのネットワークアクセスコントロールリスト（ACL）を作成し、デフォルトVPCに関連付ける  
- デフォルトVPCを備えたAWSアカウントにはデフォルトDHCPオプションセットを関連付ける  
- パブリックとプライベートのDNSホスト名が付与される
### 4-2. VPCウィザード
![](../../aws_cp_vpc_overview_vpc_wizard.png)  
VPCウィザードを利用することで一般的によく利用される構成を瞬時に構築することができます。  
### 4-3. 通常の設定
VPCウィザードを利用しない場合は以下のような流れで構築をしていきます。  
#### 1. VPCを作成（CIDR設定）
#### 2. サブネットを作成
#### 3. インターネット経路を設定（Gatewayの設定）
#### 4. VPCへのトラフィック許可の設定（ネットワークACL）
## 5. VPCのCIDR設定
VPCは/16～/28のCIDR範囲を使用できます。  
VPCのCIDRに/16を設定した際、設定できるサブネット数とIPアドレス数の組み合わせは以下のとおりです。  
サブネットあたりのIPアドレス数はAWS側で使用しているIPアドレス５つを引いた数になります。

| サブネットマスク | サブネット数 | サブネットあたりのIPアドレス数<br/>（AWSで利用可能な） |
| ---------------- | ------------ | ------------------------------------------------------ |
| /18              | 4            | 16379                                                  |
| /20              | 16           | 4091                                                   |
| /22              | 64           | 1019                                                   |
| /24              | 256          | 251                                                    |
| /26              | 1024         | 59                                                     |
| /28              | 4096         | 11                                                     |
AWSで使用しているIPアドレスは/24の場合以下のとおりです。

| ホストアドレス | 用途                        |
| -------------- | --------------------------- |
| .０            | ネットワークアドレス        |
| .1             | VPCルータ                   |
| .2             | Amazonが提供するDNSサービス |
| .3             | AWSで予約されているアドレス |
| .255           | ブロードキャストアドレス    |
## 6. サブネット
サブネットはCIDR範囲で分割したネットワークセグメントのことを言います。  
サブネットは以下の２種類の設定に用途ごとに分けて作成します。

| 種類                   | 概要                                                                                                                                                                                       |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| パブリックサブネット   | トラフィックがインターネットゲートウェイというインターネットへの出入り口にルーティングされるサブネット<br/>外部からアクセスするWebサーバーなどを配置します                                 |
| プライベートサブネット | インターネットゲートウェイへのルートがないサブネット<br/>外部からアクセスすることができないため、Webサーバーと連携するだけのDBサーバー等外部から直接アクセスがされないサーバーを配置します |

![](../../aws_cp_vpc_overview_subnet_multiple_build.png)
サブネットはVPC内に複数設置することができ、１つのAZを指定して配置されます。  

![](../../aws_cp_vpc_overview_subnet_cidr_range.png)
VPCとサブネットにはCIDR（IPアドレス範囲）が付与され、ネットワークレンジが決められます。  
一般的にVPCにCIDR/16を設定し、サブネットに/24の設定が推奨されています。  
## 7. VPCからの外部接続
![](../../aws_cp_vpc_overview_vpc_public_access.png)
パブリックサブネットからインターネットに接続するにはインターネットゲートウェイが必要になります。  

![](../../aws_cp_vpc_overview_vpc_public_access_nat.png)
プライベートサブネットからインターネットに接続するにはNATゲートウェイがパブリックサブネットに必要です。  

![](../../aws_cp_vpc_overview_vpc_out_resource_access.png)
VPCの外側にあるリソースとの通信にはパブリックのAWSネットワークかエンドポイントを利用する
## 8. VPCへのインターネット経路の設定
VPCへのインターネット経路の設定は、ルートテーブルとCIDRアドレスで以下のようにルーティングを設定します。  
- ルートテーブルでパケットの行き先を設定  
- VPC作成時にデフォルトで１つルートテーブルを作成  
- VPC内はCIDRアドレスでルーティング  
## 9. VPCの設計ポイント
VPCを設計・構築する際のポイントは以下のようになります。  
- 設計時には将来の拡張も見据えたアドレッシングや 他ネットワークとの接続性も考慮する  
- CIDR(IPアドレス)は既存のVPC、社内のDCやオフィスと被らないアドレス帯を設定し、組織構成やシステム構成の将来像も考えながら前もって計画する  
- VPC構成は自社業務に合せたVPC単体ではなくVPC全体の関係性も視野に入れる  
- 組織とシステム境界からVPCをどのように分割するか将来構成も考慮して検討する  
- 複数AZを利用して可用性の高いシステムを構築  
- サブネットは大きいサブネットを使い、パブリック/プライベートサブネットへのリソースの配置をインターネットアクセス可否から検討する  
- セキュリティグループを使ってリソース間のトラフィックを適切に制御する  
- 実装や運用を補助するツールも有効利用し、VPC Flow Logsを使ってモニタリングできるようにする  
## 10. VPCとのオンプレミス接続
VPCとオンプレミスとの接続は以下の２つの方法があります。  
- VPN接続  
- 専用線接続（Direct Connect）  
### 10-1. Direct Connect
![](../../aws_cp_vpc_overview_direct_connect_image.png)
お客様のデーターセンターやオフィスを専用線などを介してAWSへプライベートに接続するサービスです。  
Direct Connectロケーションに物理的に自社オンプレ環境を接続することでAWS環境との専用線接続を実現することができます。
### 10-2. Direct Connectのメリット
Direct Connectのメリットは以下のようなものがあります。  
- 安価なアウトバウンドトラフィック料金  
- ネットワーク信頼性の向上  
- ネットワーク帯域幅の向上  
### 10-3. Direct Connect Gateway
![](../../aws_cp_vpc_overview_direct_connect_gateway.png)
Direct Connect Gatewayにより、同一アカウントに所属する複数リージョンの複数AZから複数リージョンの複数VPCに接続できます。
### 10-4. VPNとDirect Connectの比較
VPNのほうが安く素早く利用できますが、信頼性や品質は専用線が勝ります。  

| 項目         | VPN                                                                | 専用線                                              |
| ------------ | ------------------------------------------------------------------ | --------------------------------------------------- |
| コスト       | 安価なベストエフォート回線が利用可能                               | キャリアの専用線サービス契約が必要となりVPNより割高 |
| リードタイム | クラウド上での接続設定で可能なため即時                             | 物理対応が必要なため数週間                          |
| 帯域幅       | 暗号化のオーバーヘッドにより制限がある                             | ポートあたり1G/10Gbps                               |
| 品質         | インターネット経由のためネットワーク状態の影響を受ける             | キャリアにより高い品質が保証される                  |
| 障害切り分け | インターネットベースのため自社で保持している範囲以外の確認は難しい | 物理的に経路が確保されているため比較的容易          |
## 11. VPCエンドポイント
![](../../aws_cp_vpc_overview_vpc_endpoint.png)
VPCエンドポイントはグローバルIPを持つAWSサービスに対して、VPC内から直接アクセスするための出口です。  
VPCエンドポイントはGateway型とPrivateLink型の２種類があります。  
### 11-1. Gateway型
![](../../aws_cp_vpc_overview_vpc_endpoint_gateway_type.png)
Gateway型はサブネットに特殊なルーティングを設定し、VPC内部から直接外のサービスと通信する方式です。
### 11-2. PrivateLink型
![](../../aws_cp_vpc_overview_vpc_endpoint_privatelink_type.png)
PrivateLink型はサブネットにエンドポイント用のプライベートIPアドレスを生成し、DNSが名前解決でルーティングする方式です。
### 11-3. Gateway型とPrivateLink型の比較
Gateway型とPrivateLink型の特徴を比較すると以下のとおりです。

| 特徴         | Gateway型                    | PrivateLink型              |
| ------------ | ---------------------------- | -------------------------- |
| アクセス制御 | エンドポイントポリシーを設定 | セキュリティグループを設定 |
| 料金         | 無料                         | 有料                       |
| 冗長性       | AWS側が対応                  | マルチAZ設計               |
## 12. NATゲートウェイ
![](../../aws_cp_vpc_overview_nat_gateway_image.png)
NATゲートウェイによりプライベートサブネットのリソースがインターネットまたはAWSクラウドと通信が可能になります。  
NATゲートウェイには以下のような特徴があります。  
- AWSによるマネージドNATサービス  
- EIPの割り当て可能  
- 最大10Gbpsの高パフォーマンス  
- ビルトインで冗長化されている高可用性  
- アベイラビリティゾーン毎に設置する  
## 13. VPC Flow Logs
VPC Flow Logsはネットワークトラフィックを取得し、CloudWatchでモニタリングできるようにする機能です。  
CloudWatchはAWSで利用できる監視サービスでEC2インスタンスのリソース使用率などを監視するのに利用します。  
そのためVPC Flow Logsを利用することでCloudWatchでネットワークトラフィックについても統合的に監視することができるようになります。  

VPC Flow Logsには以下のような特徴があります。  
- ネットワークインタフェースを送信元/ 送信先とするトラフィックが対象  
- セキュリティグループとネットワークACLのルールでaccepted/rejectされたトラフィックログを取得  
- キャプチャウインドウと言われる時間枠 (約10分間)で収集・プロセッシング・保存する  
- RDS、Redshift、ElasticCache、WorkSpacesのネットワークインタフェーストラフィックも取得可能  
- 追加料金はなし  
## 14. VPCの設定上限
VPCの各種設定に置いては上限数があるため大規模に利用する場合は考慮する必要があります。  

| リソース                                         | 数  |
| ------------------------------------------------ | --- |
| リージョンあたりのVPCの上限数                    | 5   |
| VPCあたりのサブネットの上限数                    | 200 |
| AWSアカウントあたりの１リージョン内のElasticIP数 | 5   |
| ルートテーブルあたりのルート上限数               | 100 |
| VPCあたりのセキュリティグループの上限数          | 500 |
| セキュリティグループあたりのルールの上限数       | 50  |
## 15. VPCを分割するケース
アプリサービスや組織構成などの用途に応じてVPCを分割する事もできます。  
分割を行う代表的なケースとしては以下のようなものがあります。  
- アプリケーションによる分割  
- 監査のスコープによる分割  
- リスクレベルによる分割  
- 本番/検証/開発フェーズによる分割  
- 部署による分割 共通サービスの切り出し  
## 16. VPC Peering
![](../../aws_cp_vpc_overview_vpc_peering_image.png)
VPC Peeringを利用することで２つのVPC間でのトラフィックルーティングが可能になります。  
VPC Peeringには以下のような特徴があります。  
- 異なるAWSアカウント間のVPC間をピア接続可能  
- 一部のリージョン間の異なるVPC間のピア接続も可能  
- 単一障害点や帯域幅のボトルネックは存在しない  

![](../../aws_cp_vpc_overview_vpc_peering_triangle_image.png)
VPC Peeringは１対１で設定する必要があるため、図のように３台で通信できるようにしたい場合は必ずそれぞれ１対１の組み合わせでVPC Peeringを設定する必要があります。