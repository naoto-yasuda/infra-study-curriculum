# ELBの概要
## 1. ELBとは
ELB（Elastic Load Balancing）はAWSでインフラを構築する際に単一障害点を排除する上で重要なサービスで、EC2インスタンスの処理を分散する際に標準的に利用する、マネージド型のロードバランシングサービスです。  
基本的には上述の通り単一障害点を排除したり、サーバーに対する負荷を下げるときにこういったELBを使って構成を作ることが標準的なアーキテクチャ設計になっています。
## 2. ELBの特徴
ELBの特徴には以下のようなものがあります。
- インスタンス間の負荷を分散する
- 異常なインスタンスを認識して対応する
    - 例えば停止しているインスタンスがあれば、そのインスタンスには通信を回さないようにすることができます
- パブリック／プライベートどちらでも使用可能
    - パブリック側に配置してエンドユーザからの通信負荷をバランシングしたり、プライベート側に配置して内部処理の負荷をバランシングしたりと目的に応じて使い分けられます
- ELB自体も負荷に応じてキャパシティを自動増減するスケーリングを実施
    - このスケーリングはAWS側で基本的に対応しており使う側は意識しないで良いのがマネージド型の利点です
- 従量課金で利用可能
    - 使った分だけ料金を支払う
- マネージドサービスなので管理が不要
    - ELB自体が単一障害点にならないようAWS側でしっかりと管理されている
- AutoScaling, Route53, CloudFormationなどと連携
## 3. ELBの主要機能
ELBの主要な機能として以下のようなものがあります。

| 機能 | 説明 |
|-------|-------|
| ヘルスチェック | EC2インスタンスの正常／異常を確認し、利用するEC2の振り分けを行う<br/><br/>通常は均等に連携するEC2インスタンスに処理を振り分けますが、異常な状態のEC2インスタンスを発見した場合はそこに対する処理の振り分けを止めるということを行っています |
| 負荷分散 | 配下のEC2の負荷に応じて、複数のAZに跨るEC2インスタンスの負荷分散を行う<br/><br/>２つのAZに均等にEC2インスタンスを配置して、そのインスタンスをELBにアタッチすることで両方のAZのインスタンスに対して均等に処理を分散することができます |
| SSLサポート | ELBでSSL Terminationできる<br/><br/>SSLを使ってセキュアな通信を可能にすることができます。<br/>トラフィックデータの暗号化をSSLによって認証することができます |
| スティッキーセッション | セッション中に同じユーザから来たリクエストを全て同じEC2インスタンスに送信する<br/><br/>セッションをSticky＝維持するという意味で、これは同じユーザに対しては１つのEC2インスタンスで連続的にやり取りするほうが効率的に処理ができますし、システムの処理によってはそのほうが都合が良いことがあります。<br/>なので同じユーザからのアクセスに対しては１回目の接続と２回目の接続で違うインスタンスに振り分けられないように設定することができます |
| Connection<br/>Draining | インスタンスが登録解除されるか異常が発生した場合に、そのバックエンドインスタンスへの新規リクエスト送信を中止する<br/><br/>ELBに設定されているインスタンスにこれ以上リクエストを送信しないという動きをしてくれるのですが、その理由は問題が発生しているインスタンスに対して未処理のリクエストがまだある場合、その処理を完了させることを優先させ新しいリクエストが行かないようにしているのです|
| S3へのログ保管 | ELBのアクセスログを指定したS3に自動保管 |
| スケーラビリティの確保 | 複数のEC2インスタンス/ECSServiceへの負荷分散 |
| 高可用性 | 複数のアベイラビリティゾーンにある複数のEC2インスタンスの中から正常なターゲットにのみ振り分け |
### 3-1. スケーラビリティの確保の補足
![](../../aws_cp_elb_overview_scalability_image.png)
負荷分散の割合を数値で設定して分散を行うこともできます。
### 3-2. 高可用性の補足
![](../../aws_cp_elb_overview_highavailability_image.png)
AZの複数のインスタンスにヘルスチェックを行って、１つが停止すれば別の方に集中するという処理をすることが行えます。
## 4. ELBのタイプ
現在ELBには３つのタイプのロードバランサーがあり、それぞれ用途に応じて使い分けることができます。
### 4-1. クラシックロードバランサー（CLB）
![](../../aws_cp_elb_overview_clb_image.png)
ELBというサービスがリリースされた当初から提供されているELBのタイプで、標準的なL4/L7におけるロードバランシングが可能ですが、複雑な設定は行なえません。  
通常のロードバランシングで標準的にやりたいことはこのCLBで実現できますが、例えばそこから更にインスタンスごとに機能を分けて、機能毎に１つのCLBで処理すると言ったようなことは苦手です。  

主な特徴をまとめると、
- HTTP/HTTPSとTCP/SSLプロトコルのL4とL7に対応
- Proxyプロトコルによる発信元IPアドレス識別
- ELBとバックエンドのEC2インスタンス間でHTTPS/SSL使用時にサーバ証明書認証を実施
- CLB配下のインスタンスは、全て同一の機能を持ったインスタンスが必要
- 異なる機能に対してコンテントベースルーティングは出来ない
### 4-2. アプリケーションロードバランサー（ALB）
![](../../aws_cp_elb_overview_alb_image.png)
ALBはレイヤー7の対応が強化された単一ロードバランサーで、異なるアプリケーションへリクエストをルーティングすることが可能です。  
Webアプリケーション用としてロードバランサーを利用する場合はこちらのALBを使うことが主流になっています。  

主な特徴をまとめると、
- URLのパスに基いてルーティングが可能なパスベースルーティングが可能
- WebSocketとHTTP/2のリクエストを受付
- １インスタンスに複数ポートを登録可能
- EC2インスタンスをターゲットグループに割り当てる際、複数ポートを個別のターゲットとして登録することが可能なため、ポートを利用するコンテナをロードバランシング可能
    - Elastic Container Service（ECS）というAWSのコンテナサービスがあり、そういったコンテナもバランシングすることが可能
- ターゲットグループでのヘルスチェックが可能
    - CLBでは個々のEC2インスタンスに対してヘルスチェックを行っていたが、ALBターゲットグループというEC2インスタンスをグループ化したものに対してグループ単位でのヘルスチェックを行うことができる  
    - ターゲットグループによるヘルスチェックができることで、複数のターゲットグループを連携したロードバランシングを行うことができます
- アクセスログの情報追加
- EC2と同様に削除保護が可能
- ALB自体が自動的にキャパシティを増減
#### 4-2-1. CLBとALB
![](../../aws_cp_elb_overview_clb_and_alb_image.png)
CLBとALBを比較すると、ALBでパスルーティングによる複数機能にバランスが可能になった点が大きな違いになります。  
例えば図のように注文機能のAPサーバーと調達機能のapサーバーでバランシングをしなければならない時にCLBとELBで以下のような違いがあります。
##### ・CLB
- 基本的にはorder.japan.comとProcure.japan.comという２つのURLに分けて使う
- その場合２つのURLそれぞれのELBを設定しなければならない
##### ・ALB
- パスルーティングでjapan.comの/の下にorderとprocureはという形で分けることによって、１つのALBからそれぞれのグループのサーバーを負荷分散できる

この様により複雑な構成を１つのLBで対応できるのがALBのCLBと比較した際の大きな違いになっています。
### 4-3. ネットワークロードバランサー（NLB）
NLBは超低遅延で高スループットを維持しながら秒間何百万リクエストを捌く様に設計された新しいロードバランサーです。  
かなりの大量のリクエストが想定されるケースにこちらを使っていくことになります。  
基本的には現在はALBを利用するのが最も標準的な選択にはなるのですが、高負荷や高スループットや膨大なリクエスト数が予定されているシステムにはこちらのNLBが適しています。

主な特徴をまとめると、
- 開放型システム間相互接続 (OSI) モデルの固定IPアドレスを持つL4ロードバランサ
  - ALBはL7に特化、CLBはL4に特化しているがシンプルな設定のみというように、各ロードバランサー毎にOSIモデルのレイヤーが異なることを理解する
- 揮発性ワークロードを処理し、毎秒数百万のリクエストに対応できる能力
- VPC外のターゲットを含めたIP アドレスや静的IPアドレスでの登録可能
- 複数のポートで各インスタンスまたは IP アドレスを同ターゲットグループに登録可能
- 大規模アクセスが予測される際にCLBやALBで必要だったPre-warming申請が不要
  - CLBやALBでは大規模アクセスが予測される際はサポートにPre-warming申請（事前暖機申請）を行う必要があります
- ALBやCLBはX-Forwarded-Forでアクセス元IPアドレスを判断していたが、NLBは送信元IPアドレスと送信元ポートの書き換えを行わないため、パケットからアクセス元が判断可能
- NLBはフォルトトレランス機能を内蔵したコネクション処理を持ち、数カ月から数年のオープンなコネクションを処理できる
- コンテナ化されたアプリケーションのサポート
- 各サービスの個別のヘルスステータスのモニタリングのサポート

### 5. まとめ
このようにELBは３つのタイプが有り、それぞれ機能が違うので、用途に応じて使い分けるという設計が必要になってきます。