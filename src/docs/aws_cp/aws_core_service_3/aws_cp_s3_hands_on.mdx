# S3の作成（ハンズオン）
このハンズオンではS3の各種操作方法について学習していきます。
## 1. S3の管理メニューの確認
まずはS3の各管理メニューの内容を確認していきましょう。
### 1-1. S3の管理コンソールの表示
![](../../aws_cp_s3_hands_on_check_managementconsole_1.png)  
左上の「サービス」をクリックし、「ストレージ」-「S3」をクリックします。

### 1-2. 左メニューの内容確認
![](../../aws_cp_s3_hands_on_check_managementconsole_2.png)
左メニューの「バケット」をクリックするとバケットの一覧が表示されており、各バケットのデータの内容や設定内容を確認することができます。

![](../../aws_cp_s3_hands_on_check_managementconsole_3.png)
左メニューの「アクセスポイント」をクリックするとアクセスポイントの一覧が表示されており、各アクセスポイントの設定内容などを確認することができます。  
アクセスポイントはバケット単位でアクセス制限をコントロールするバケットポリシーとは別にアクセスポイントという接続先単位でアクセス制御をコントロールできる機能です。  
バケットポリシーだけで権限を管理していくと設定が多くなっていくにつれ管理が煩雑になっていくのですが、アクセスポイントを利用者単位で設定することで個別にアクセス制御の設定ができるため管理をしやすくすることができます。

![](../../aws_cp_s3_hands_on_check_managementconsole_4.png)
左メニューの「オブジェクトLambdaアクセスポイント」をクリックするとオブジェクトLambdaアクセスポイントの一覧が表示されており、各オブジェクトLambdaアクセスポイントの設定内容などを確認することができます。  
オブジェクトLambdaはS3のオブジェクトに対するGetリクエスト時に独自のコードを実行し、オブジェクトに対する処理を実行して、処理したオブジェクトをクライアントに返すことができる機能です。  
オブジェクトLambdaアクセスポイントはそのためのアクセスポイントです。

![](../../aws_cp_s3_hands_on_check_managementconsole_5.png)
左メニューの「マルチリージョンアクセスポイント」をクリックするとマルチリージョンアクセスポイントの一覧が表示されており、各マルチリージョンアクセスポイントの設定内容などを確認することができます。  
マルチリージョンアクセスポイントは１つのアクセスポイントに対し複数リージョンの複数バケットを登録することで最も遅延が無いバケットへと自動的にアクセスをルーティングしてくれます。  

![](../../aws_cp_s3_hands_on_check_managementconsole_6.png)
左メニューの「バッチオペレーション」をクリックするとジョブの一覧が表示されており、各ジョブの内容などを確認することができます。  
バッチオペレーションはS3バケットのリストに対してデータ処理をする際のバッチ処理というのを作ることができます。  
オブジェクトのリストに対して一斉に何らかのデータ処理をしたい、という場合にこの機能でジョブを作ってバッチ処理をすることができます。

![](../../aws_cp_s3_hands_on_check_managementconsole_7.png)
左メニューの「S3のアクセスアナライザー」をクリックするとS3のアクセスアナライザーの設定画面が表示されます。  
デフォルトでは有効化されていないため、その旨のメッセージが表示されています。  
S3のバケットは様々なポリシーでアクセス制御をしていくことになりますが、そのポリシーの設定状況が想定している対象から外れていないか、想定外の作り方がされていないか等を全体的にチェックすることができます。

![](../../aws_cp_s3_hands_on_check_managementconsole_8.png)
左メニューの「このアカウントのブロックパブリックアクセス設定」をクリックするとこのアカウントに関するブロックパブリックアクセス設定を確認することができます。
S3のバケットに対するインターネットからのアクセス許可・拒否を設定することができます。  
デフォルトではアクセスがブロックされるようになっています。

![](../../aws_cp_s3_hands_on_check_managementconsole_9.png)
左メニューの「Storage Lens」-「ダッシュボード」をクリックするとStrage Lensの設定一覧を確認することができます。  
Storage Lensはこのストレージの状態をドリルダウンして使用状況や傾向を解析してくれて、それをダッシュボード上に可視化してくれる機能です。

![](../../aws_cp_s3_hands_on_check_managementconsole_10.png)
左メニューの「Storage Lens」-「AWS Organizationsの設定」をクリックするとStorage LensのAWS Organizationsの設定を確認することができますが、デフォルトでは設定がされていないため使用できない旨が表示されています。  
AWS Organizationsは複数のAWSアカウントを統合して一元管理できるサービスなのですが、Storage Lensで全てのAWSアカウントを確認できるようにすることができます。

![](../../aws_cp_s3_hands_on_check_managementconsole_11.png)
左メニューの「AWS Marketplace」をクリックするとマーケットプレイス上で売られているS3の関連製品を確認することができます。  
S3の利用することができるサードパーティの製品を購入して利用することができます。  
データの分析機能や監視に関する機能など各種カテゴリごとに製品を確認することができます。
## 2. バケットの作成
それでは実際にバケットを作成してみましょう。
### 2-1. バケットの作成
![](../../aws_cp_s3_hands_on_make_bucket_1.png)
左メニューより「バケット」をクリックし、バケットの一覧を表示して「バケットを作成」をクリックします。

![](../../aws_cp_s3_hands_on_make_bucket_2.png)
以下のように設定を入力して「バケットを作成」をクリックします。

| 項目 | 設定内容 | 説明 |
|-------|-------|-------|
| バケット名 | test-bucket-<現在日時> | バケットの名前<br/>グローバルで一意である必要があるので、アカウントIDや現在日時等を含めて固有のものになるようにしましょう |
| AWSリージョン | ap-northeast-1 | 作成先のリージョン |
| 既存のバケット設定からコピー | デフォルト | 既存のバケットを選択して設定をコピーできる |
| パブリックアクセスをすべてブロック | チェックオン | インターネットからのアクセスを無効にするかどうか |
| バケットのバージョニング | 無効 | バケットのファイルをバージョン管理するか |
| タグ | デフォルトのまま | AWSリソースに割り当てるラベル |
| サーバー側の暗号化 | 有効にする | サーバーサイドを暗号化するかどうか |
| 暗号化キータイプ | AmazonS3キー | 暗号化に利用するキーのタイプ |
| オブジェクトロック | 無効にする | オブジェクトの削除や上書きをできないようにするかどうか<br/>バケット作成時にしか変更できず、作成後に有効もしくは無効にすることはできない |

![](../../aws_cp_s3_hands_on_make_bucket_3.png)
バケットの一覧に作成したバケットに表示されていることを確認します。

## 3. バケットの設定内容の確認
作成したバケットの設定内容について確認してみましょう。
### 3-1. オブジェクトタブの設定確認
![](../../aws_cp_s3_hands_on_check_bucket_setting_1.png)
このタブにバケット配下のフォルダやオブジェクトが表示されます。  
ファイルをダウンロードしたり、アップロードや削除などを行うことができます。
### 3-2. プロパティタブの設定確認
![](../../aws_cp_s3_hands_on_check_bucket_setting_2.png)
バケットの概要や各種機能の設定を確認することができます。  

| 項目 | 説明 |
|-------|-------|
| バケットの概要 | 作成したバケットの概要情報 |
| バケットのバージョニング | バケットのバージョン管理をするかしないか |
| Multi-Factor Authentication (MFA) の削除 | バージョン管理で管理されているバージョンを完全に削除する際にスマホなどを使った多要素認証を必要とするかしないか |
| タグ | AWSリソースに割り当てるラベル |
| デフォルトの暗号化 | 暗号化するかしないか |
| サーバー側の暗号化 | 暗号化に利用するキーのタイプ |
| Intelligent-Tiering Archive 設定 | アクセスが行われないファイルを自動で低頻度アクセス用のストレージに入れ、逆に低頻度アクセス用のストレージに移動されたファイルが利用された場合は通常のストレージに移動させることでコストの最適化をさせる機能を有効にするかしないか |
| サーバーアクセスのログ記録 | バケットへのアクセスのログを記録するかしないか |
| AWS CloudTrail データイベント | CloudTrailというサービスでS3のオブジェクトに対するAPIオペレーションをログに記録するかしないか |
| イベント通知 | バケットで特定のイベントが発生した時に通知を送信するかしないか |
| Transfer Acceleration | 海外リージョンなど、送信元から遠く離れたS3へのデータ転送をAWSのエッジロケーションとネットワークプロトコルの最適で高速化する機能を有効にするかしないか |
| オブジェクトロック | オブジェクトの削除や上書きをできないようにするかどうか |
| リクエスタ支払い | S3は保存しているデータ量とは別にデータを取り出す際の転送量も課金が行われるが、別のAWSアカウントからのアクセスを許可している場合にアクセスしに来たアカウント側に転送量の課金を支払わせるかしないか |
| 静的ウェブサイトホスティング | S3バケットにindex.htmlなどのHTMLファイルを配置して、静的なWebサイトサーバーとして利用するかしないか<br/>ランディングページだけのような静的なシンプルなサイトであればEC2で構築するよりも安価に作成することができる |
### 3-3. アクセス許可タブの設定確認
![](../../aws_cp_s3_hands_on_check_bucket_setting_3.png)
バケットに対するアクセスに関する設定を確認することができます。

| 項目 | 説明 |
|-------|-------|
| アクセス | バケットとオブジェクトに対するパブリックアクセスが許可されているかどうか |
| ブロックパブリックアクセス | インターネットからのアクセスを無効にするかどうか |
| バケットポリシー | バケットに対するアクセスの制限をコントロールするJSONのポリシー |
| オブジェクト所有者 | バケットにアップロードされたオブジェクトの所有者 |
| アクセスコントロールリスト | オブジェクト単位まで行えるアクセス許可の設定 |
| Cross-Origin Resource Sharing (CORS) | 複数のドメインに対してS3をオリジンとして設定することができる機能 |
### 3-4. メトリクスタブの設定確認
![](../../aws_cp_s3_hands_on_check_bucket_setting_4.png)
バケットの利用状況などのデータを確認することができます。

| 項目 | 説明 |
|-------|-------|
| バケットメトリクス | バケットの使用状況のグラフ |
| ストレージクラス分析 | ストレージへのアクセスパターンを分析して、オブジェクトを適切なストレージクラスに移行するタイミングを判断してくれる機能 |
| レプリケーションメトリクス | 他リージョンにレプリケーションしている際の利用状況のデータ |
### 3-5. 管理タブの設定確認
![](../../aws_cp_s3_hands_on_check_bucket_setting_5.png)

| 項目 | 説明 |
|-------|-------|
| ライフサイクルルール | ストレージのクラスの移動やファイルの削除をルールによって自動で行うようにできる機能 |
| レプリケーションルール | 別リージョンにレプリケーションを行う際の設定 |
| インベントリ設定 | バケットにインベントリ設定を作成して、オブジェクトとメタデータのフラットファイルリストを生成できる機能 |
### 3-6. アクセスポイントタブの設定確認
![](../../aws_cp_s3_hands_on_check_bucket_setting_6.png)
1-2. で説明したアクセスポイントに関する設定の内容を確認することができます。
## 4. バケットへのデータアップロード
作成したバケットにファイルアップロードなどをしていきましょう。
### 4-1. フォルダの作成
![](../../aws_cp_s3_hands_on_upload_file_1.png)
まずはフォルダを作成するため「フォルダの作成」をクリックします。

![](../../aws_cp_s3_hands_on_upload_file_2.png)
以下のようにフォルダの設定を入力して「フォルダの作成」をクリックします。

| 項目 | 設定 | 説明 |
|-------|-------|-------|
| フォルダ | test | 作成するフォルダの名前 |
| サーバー側の暗号化 | 有効にする | 暗号化するかしないか |
| 暗号化キータイプ | AmazonS3キー | 暗号化に利用するキーのタイプ |

### 4-2. ファイルのアップロード
![](../../aws_cp_s3_hands_on_upload_file_3.png)
作成したtestフォルダをクリックします。

![](../../aws_cp_s3_hands_on_upload_file_4.png)
「アップロード」をクリックします。

![](../../aws_cp_s3_hands_on_upload_file_5.png)
以下のようにアップロードするファイルの設定を入力して「アップロード」をクリックします。

| 項目 | 設定 | 説明 |
|-------|-------|
| ファイルとフォルダ | 任意のファイル | アップロードするファイルまたはフォルダ |
| 送信先 | 送信先：testバケット<br/>バケットのバージョニング：無効<br/>デフォルトの暗号化：有効<br/>オブジェクトロック：無効 | 送信先のバケットおよびバージョニングや暗号化の設定 |
| アクセスコントロールリスト | 事前定義されたACLからの選択 | 基本的な読み取り・書き込みのアクセス許可の設定のリスト |
| 事前定義されたACL | プライベート | 利用する事前定義されたACL |
| ストレージクラス | スタンダード | S3のストレージクラス |
| サーバー側の暗号化 | 暗号化キーを指定する | 暗号化キーを指定するかしないか |
| 暗号化設定 | デフォルトの暗号化バケット設定を使用する | 暗号化の設定を暗号化バケット設定を使用するか、オブジェクトのバケット設定で上書きするか |
| タグ | デフォルトのまま | AWSリソースに割り当てるラベル |
| メタデータ | デフォルトのまま | 名前-値 (キーと値) のペアとして提供されるオプションの情報 |

### 4-3. アップロードされたファイルの確認
![](../../aws_cp_s3_hands_on_upload_file_6.png)
アップロードしたファイルをクリックします。

![](../../aws_cp_s3_hands_on_upload_file_7.png)
「プロパティ」タブをクリックするとアップロードしたファイルの設定の内容を確認することができます。

![](../../aws_cp_s3_hands_on_upload_file_8.png)
「アクセス許可」タブをクリックすると設定したファイルのアクセス許可を確認することができます。

![](../../aws_cp_s3_hands_on_upload_file_9.png)
「バージョン」タブをクリックするとバージョン管理していた場合に管理されているファイルのバージョンを確認することができます。
### 4-4. アップロードしたファイルへのアクセス
![](../../aws_cp_s3_hands_on_upload_file_10.png)
「プロパティ」タブに戻って「オブジェクトURL」のリンクをクリックします。

![](../../aws_cp_s3_hands_on_upload_file_11.png)
そうするとエラー画面が表示されます。  
オブジェクトの所有者として権限は持っているはずですが、これはインターネットからアクセスをしていることになるためブロックパブリックアクセスの設定によりアクセスが拒否されているためになります。  

![](../../aws_cp_s3_hands_on_upload_file_12.png)
なのでブロックパブリックアクセスの設定を修正します。
バケットの設定画面に移動し、「アクセス許可」タブを表示して、「ブロックパブリックアクセス」-「編集」をクリックします。

![](../../aws_cp_s3_hands_on_upload_file_13.png)
「ブロックパブリックアクセス」-「パブリックアクセスをすべてブロック」のチェックを外して「変更の保存」をクリックします。

![](../../aws_cp_s3_hands_on_upload_file_14.png)
確認ウィンドウが表示されるので、「確認」と入力欄に「確認」をクリックします。

![](../../aws_cp_s3_hands_on_upload_file_15.png)
再度アップロードしたファイルにアクセスします。  
するとまたエラー画面が表示されます。  
これはパブリックアクセスに関しては許可がされましたが、実はオブジェクトごとにも許可設定が必要になるからです。

![](../../aws_cp_s3_hands_on_upload_file_16.png)
アップロードしたファイルの管理画面に移動して「オブジェクトアクション」-「公開する」をクリックします。

![](../../aws_cp_s3_hands_on_upload_file_17.png)
対象を確認した上で「公開する」をクリックします。

![](../../aws_cp_s3_hands_on_upload_file_18.png)
この状態で再度アップロードしたファイルを表示するとファイルの内容が表示されるようになります。