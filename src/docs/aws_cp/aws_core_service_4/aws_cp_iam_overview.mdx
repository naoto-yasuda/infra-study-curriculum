# IAMの概要
## 1. IAMとは
AWS Identity and Access Management（IAM）は安全にAWS操作を実施するための認証・認可の仕組みです。  
- AWS利用者認証の実施
- アクセスポリシーの設定
- ユーザ個人またはグループ毎に設定  

上記のようなことが行なえ、各ユーザの認証の設定や、どの様に権限を持っているかの設定、その設定をユーザ個人かグループごとに設定するかを決めて設定していきます。

![](../../aws_cp_iam_overview_iam_image.png)
図のように設定の基本的な単位としては個人とグループがあり、例えばユーザ個人の権限ではEC2のみしか権限を持っていなくてS3は利用できない場合でも、S3への権限を持っているグループにユーザが所属していればS3を利用することができます。
## 2. IAMの主要トピック
IAMの主要な要素として
- ユーザ
- グループ
- ポリシー
- ロール  

があります。
### 2-1. ユーザ
ユーザには
- rootユーザ
- IAMユーザ  

の２種類があります。
#### 2-1-1. rootユーザ
AWSのアカウント作成時に作られるユーザです。  
通常の運用操作ではこのrootユーザは使用しません。  
rootユーザは全てのAWSサービスに対する権限を有しており、自身のアカウント内のAWSサービスの管理であれば何でもできてしまうため、使い勝手は良いですが流出時のリスクが大きいためなるべく利用しないようにします。  
またMFA（多要素）認証を設定して二重三重にセキュリティの設定を行うことが重要になってきます。  

rootユーザをなるべく使わないようにするもう１つの理由として、rootユーザはrootユーザのみの以下のような権限を有しています。
- AWSルートアカウントのメールアドレスやパスワードの変更
  - 登録時に設定したメールアドレスやパスワードはrootユーザでしか変更できません
- IAMユーザーの課金情報へのアクセスに関するactivate/deactivate
  - IAMユーザは元々課金情報へはアクセスができないため、させたい場合はrootユーザで設定変更が必要です
- 他のAWSアカウントへのRoute53のドメイン登録の移行
  - Route53で取得したドメインを他のAWSアカウントへ移行することができますが、この操作もrootユーザでのみ行なえます
- CloudFront用のキーの作成
- AWSサービス（サポート等）のキャンセル
- AWSアカウントの停止
- コンソリデイテッドビリングの設定
  - 複数アカウントで統合しての請求書支払いの設定はrootユーザでしか行なえません
- 脆弱性診断フォームの提出
  - 構築したシステムやアプリケーションに対してどのくらい脆弱性があるかをAWS側に診断してもらえますが、その診断フォームの提出はrootユーザしか行なえません
- 逆引きDNS申請
### 2-2. IAMユーザ、IAMグループ
![](../../aws_cp_iam_overview_iamuser_and_iamgroup.png)
先程の図で言う個人がIAMユーザ、グループがIAMグループになります。
### 2-3. IAMポリシー
![](../../aws_cp_iam_overview_iampolicy_image.png)
IAMポリシーは図の赤い部分の○×の設定、つまりはどのリソースにアクセスできる・できないといった権限をポリシーに記述して設定していくものになります。  
IAMポリシーには大きく２つの領域で３つの種類があります。  

![](../../aws_cp_iam_overview_policytype.png)
#### 2-3-1. 管理ポリシー
管理ポリシーは基本的に管理者権限で作って管理をしているポリシーです。
##### 2-3-1-1. AWS管理ポリシー
AWS管理ポリシーはAWS側が作成して管理しているポリシーになります。
##### 2-3-1-2. カスタマー管理ポリシー
カスタマー管理ポリシーは個々のAWSアカウントで作成・管理する管理ポリシーです。  
うちの組織・うちの会社としてアカウントにはこういう管理ポリシーを作るといったものを設定したものになります。  
#### 2-3-2. インラインポリシー
インラインポリシーはユーザ、グループまたはロールというものに対してアタッチするポリシーをインラインポリシーと言います。

![](../../aws_cp_iam_overview_policy_json.png)
IAMポリシーはJSON形式で設定を行っていきます。  
JSONはテキストで記述しますが、プログラミング言語よりは人間が分かりやすいように記述する形式です。  
記述のルールは、

| 項目 | 説明 |
|-------|-------|
| Effect | "Allow"　→　許可<br/>"Deny"　→　拒否 |
| Action | 対象のAWSサービスと操作<br/>例："s3:Get" |
| Resource | 対象のAWSリソース<br/>ARNで記述します |
| Condition | アクセス制御が有効となる条件<br/>例：IPアドレスの制限など |
となっています。
### 2-4. IAMロール
![](../../aws_cp_iam_overview_iamrole_image.png)
IAMロールを利用することでユーザやグループではなくサービスに対してポリシーを設定することができます。  
EC2やS3など一部のサービスだけではありますが、ユーザなどと同じ様に設定できます。  
別のサービスと連携できるようなサービスでサービス間で権限を与えるために使用できます。  
例えばEC2からS3にアクセスするといった場合に利用できます。
## 3. ユーザのアクティビティの記録
個々のユーザのアクティビティを記録するサービスとして以下のようなものがあります。

| サービス名 | 説明 |
|--------|--------|
| Access AdvisorのService LastAccessed Data | IAMエンティティ(ユーザー、グループ、ロール)が、最後にAWSサービスにアクセスした日付と時刻を表示する機能 |
| Credential Report | 利用日時などが記録されたIAM認証情報に係るレポートファイル |
| AWS Config | IAMのUser、Group、Role、Policyに関して変更履、構成変更を管理・確認することができる機能 |
| AWS CloudTrail | AWSインフラストラクチャ全体でアカウントアクティビティをログに録し、継続的に監視し、保持することができる機能 |
## 4. アクセス権限の一時付与
以下のようなサービスを利用することで一時的にアクセス権限の付与をすることができます。

| サービス名 | 説明 |
|--------|--------|
| AWS Security Token Service(STS) | 動的にIAMユーザーを作り、一時的に利用するトークンを発行するサービス |
| Temporary Security Credentials | AWSに対して一時的な認証情報を作成する仕組み |
## 5. IAMとAWS Organizations
### 5-1. AWS Organizationsとは
![](../../aws_cp_iam_overview_iam_and_awsorganizations.png)
IAMとは別のAWSサービスになりますが、同じ様にアカウント管理をするサービスとして「AWS Organizations」というものがあります。  
図のようにIAMアカウントはAWSアカウント内のユーザ管理を実施しますが、AWS Organizationsは会社や組織内で複数のAWSアカウントを保持していた場合に複数アカウントを統制するためのサービスです。  
IAMの更に上の部分を管理するサービスと思っていただければと思います。
### 5-2. AWS Organizationsの特徴
AWS OrganizationsはIAMのアクセス管理を大きな組織でも楽に実施できるようにするマネージド型サービスです。  
以下のような特徴があります。

| 特徴 | 説明 |
|-------|-------|
| 複数アカウントの一元管理 | AWSアカウントをグループ化してポリシーを適用して一元的に管理する |
| 新規アカウント作成の自動化 | コンソール／SDK／CLIでAWSアカウントを新規作成して、作成内容をログ管理できる |
| 一括請求 | 複数AWSアカウントの請求を一括化する<br/>まとめることでボリュームディスカウントを受けられたりもします |
### 5-3. AWS Organizationsのアカウント管理の仕方
![](../../aws_cp_iam_overview_organizations_setting_image.png)
AWS Organizationsのアカウント管理の仕方は、図のような形でマスターアカウントとなるAWSアカウントに対してOUという組織単位のAWSアカウントを所属させてメンバーアカウントとして管理するということができます。  
例えばマスターアカウントを会社として作成し、営業部や技術部など部署単位でメンバーアカウントのAWSアカウントを作成・所属させるといったような形です。